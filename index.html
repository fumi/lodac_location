<!DOCTYPE html>
<html> 
<head> 
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/> 
    <title>LODAC location</title> 
    <script src="http://maps.google.com/maps/api/js?sensor=true" type="text/javascript"></script>
    <script type="text/javascript" src="http://code.google.com/apis/gears/gears_init.js"></script> 
    <script type="text/javascript" 
        src="https://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
    <script type="text/javascript"> 

    var map;
    var geocoder;
    var markers = {};
    var new_markers = {};
    var dist_array = new Array();
    var info_window;
    var opened_marker_link = "";
    var center;
    var ne, sw, ne_lat, ne_lng, sw_lat, sw_lng;

    function initialize(){
        var options = {
            zoom: 16,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        map = new google.maps.Map($("#map")[0], options);
      
        geocoder = new google.maps.Geocoder(); 
       
        if (navigator.geolocation){
            browserSupportFlag = true;
            navigator.geolocation.getCurrentPosition(function(position){
                map.setCenter(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
            }, function(){
                handleNoGeolocation(browserSupportFlag);
            });
        }else{
            map.setCenter(new google.maps.LatLng(35.693308,139.758282));
        } 
        google.maps.event.addListener(map, "idle", function(){
            showAllLocation(); 
        });
    } 
  
    function updateCenterAndBounds(){
        center = map.getCenter();
        ne = map.getBounds().getNorthEast();
        sw = map.getBounds().getSouthWest();
        ne_lat = ne.lat();
        ne_lng = ne.lng();
        sw_lat = sw.lat();
        sw_lng = sw.lng();
        $("#bounds").append("中心座標： " + center + "<br/>表示範囲：<br/>" + ne + ", " + sw);
    }
   
    function removeMarker(link){
        markers[link].setMap(null);
        delete markers[link];
    } 

    function removeOldMarkers(){
        for(m in markers){
            if(!(m in new_markers)){
                removeMarker(m);
            }
        }
    }
    
   function generateMarker(info){
        var pos = new google.maps.LatLng(info.lat, info.lng);
        dist_array.push({link: info.link, dist: info.dist});
        if(info.link in markers){
            new_markers[info.link] = {marker: markers[info.link].marker, info: info};
        }else{
            var options = {
                map: map,
                position: pos
            };
            new_markers[info.link] = {marker: new google.maps.Marker(options), info: info};
        } 
   }

    function setInfoWindow(marker_obj){
        var pos = new google.maps.LatLng(marker_obj.info.lat, marker_obj.info.lng);
        var content = "<b>"+marker_obj.info.id+"</b>: <a href=\""+marker_obj.info.link+"\">"+marker_obj.info.title+"</a>"; 
        if(content.length > 0){
            var info_options = {
                content: content
            };

            google.maps.event.addListener(marker_obj.marker, "click", function(){ 
                if (info_window){
                    info_window.close();
                    opened_marker_link = "";
                }
                /*map.panTo(pos);*/
                info_window = new google.maps.InfoWindow(info_options);
                info_window.open(map, marker_obj.marker);
                opened_marker_link = marker_obj.info.link;
            }); 
        }
    }

    function openInfoWindow(link){
        var m = markers[link];
        var pos = new google.maps.LatLng(m.info.lat, m.info.lng);
        var content = "<b>"+m.info.id+"</b>: <a href=\""+m.info.link+"\">"+m.info.title+"</a>"; 
        if(info_window){
            info_window.close();
            oepned_marker_link = ""; 
        }
        info_window = new google.maps.InfoWindow({content: content});
        info_window.open(map, m.marker);
        opened_marker_link = link;
        map.panTo(pos);
    }
        
    function showAllLocation(){
        $("#bounds").empty();
        $("#result").empty();
        updateCenterAndBounds();
        dist_array = new Array();
        
        $.ajax({
            type: "GET",
            url: "location.cgi",
            data: "endpoint=dbpedia&NE_lat="+ne_lat+"&NE_long="+ne_lng+"&SW_lat="+sw_lat+"&SW_long="+sw_lng,
            dataType: "json",
            success: function(data){
                var data_num = data.results.bindings.length;
                var results = "";
                for (var i=0; i<data_num; i++){
                    var loc = data.results.bindings[i];
                    var lat = loc.lat.value;
                    var lng = loc.long.value;
                    var title = loc.title.value;
                    var link = loc.link.value;
                    var dist = calcDistance(lat, lng, center.lat(), center.lng());
                    var info = {id: 0, lat: lat, lng: lng, title: title, link: link, dist: dist}; 
                    generateMarker(info);
                }
                removeOldMarkers();
                markers = new_markers;

                dist_array.sort(function(a,b){return (a.dist-b.dist)});
                for (var i=0; i<data_num; i++){
                    var m = markers[dist_array[i].link]; 
                    m.info.id = i+1;
                    /*results += "<b>"+m.info.id+"</b>\t<a href=\""+m.info.link+"\">"+m.info.title+"</a>  ("+lat+", "+lng+")<br/>";*/
                    results += "<b>"+m.info.id+"</b>\t<a href=\"javascript:void(0);\" onclick=\"openInfoWindow('"+m.info.link+"');\">"+m.info.title+"</a>  ("+lat+", "+lng+")<br/>";
                    setInfoWindow(m);
                }

                if(info_window && opened_marker_link.length > 0){
                    var info = markers[opened_marker_link].info;
                    var content = "<b>"+info.id+"</b>: <a href=\""+info.link+"\">"+info.title+"</a>"; 
                    info_window.setContent(content);
                }

                $("#result").append(results);
            }
        });
    }

    function setCenterAs(){
        new_center = $("#center_location").val(); 
      
        $.ajax({
            type: "GET",
            url: "geocoding.cgi",
            data: "new_center="+new_center,
            dataType: "xml",
            success: function(data){
                var lat = $(data).find("coordinate").find("lat").text();
                var lng = $(data).find("coordinate").find("lng").text();
                map.setCenter(new google.maps.LatLng(lat, lng));
            }
        });
    }

    function calcDistance(lat1, lng1, lat2, lng2){
        var r = 6378.137;
        var d = r * Math.acos(Math.sin(lng1) * Math.sin(lng2) + Math.cos(lng1) * Math.cos(lng2) * Math.cos(lat1-lat2));
        return d; 
    }

    function pressEnter(){
        if(window.event.keyCode == 13){
            setCenterAs(); 
        } 
    }
    </script>
</head> 
<body onload="initialize()">
    <div id="leftbox" style="float: left; margin: 10px">  
        <div id="control" style="width: 600px; height: 35px; padding-top: 10px">
            <input type="text" id="center_location" style="width: 400px" onKeyPress="pressEnter();"/>
            <input type="button" id="center_button" value="この地点を中心にする" onclick="setCenterAs();"/> 
        </div>
        <div id="map" style="width: 600px; height: 400px;"></div>
        <div id="bounds" style="width: 600px; height: 100px; padding-top: 10px"></div>
        <div id="referrer" style="width: 600px; padding-top: 10px">
            <script type="text/javascript" language="javascript">
            <!--
            document.write("リファラー: " + document.referrer);
            // -->
            </script>
        </div>  
    </div> 
    <div id="rightbox" style="float: left; margin: 10px"> 
        <div id="result" style="width: 600px; height: 500px;"></div>
    </div>
</body> 
</html>
